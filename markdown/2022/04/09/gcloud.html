<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Gcloud cheatsheet</h1><p class="page-description">Most used commands while working with gcloud</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-04-09T00:00:00-05:00" itemprop="datePublished">
        Apr 9, 2022
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      2 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#markdown">markdown</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#initial-setup">Initial setup</a></li>
<li class="toc-entry toc-h2"><a href="#working-with-tpu-vms">Working with TPU VMs</a></li>
<li class="toc-entry toc-h2"><a href="#working-with-tpu-vms-via-vs-code">Working with TPU VMs via VS-code</a></li>
</ul><h2 id="initial-setup">
<a class="anchor" href="#initial-setup" aria-hidden="true"><span class="octicon octicon-link"></span></a>Initial setup</h2>
<p>Following <a href="https://cloud.google.com/tpu/docs/run-calculation-jax">this guide</a>.</p>

<ul>
  <li>To set default email, project-id &amp; zone:
    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>gcloud config set account your-email-account
gcloud config set project your-project-id
gcloud config set compute/zone us-central1-f  # us-central1-f for free v2 TPUs and europe-west4-a for free v3 TPUs (only if you have free TRC access)
</code></pre></div>    </div>
  </li>
  <li>To get currently active project and zone related info:
    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>gcloud info
</code></pre></div>    </div>
  </li>
  <li>To create an identity (I don’t know if this is required or not. This command should trigger installation of “gcloud Beta Commands” automatically in another shell and then you need to rerun the following command):
    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>gcloud beta services identity create --service tpu.googleapis.com
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="working-with-tpu-vms">
<a class="anchor" href="#working-with-tpu-vms" aria-hidden="true"><span class="octicon octicon-link"></span></a>Working with TPU VMs</h2>
<p>There are two different terms here: “TPU VMs” and “TPU nodes”. TPU nodes can be connected externally via another VM. TPU VMs are stand-alone systems with TPUs, RAM and CPU (96 core Intel 2 GHz processor and 335 GB RAM). We may be charged via GCP for the VM (CPUs and RAM). (I will update this info once I know for sure):</p>

<p><img width="512" alt="image" src="https://user-images.githubusercontent.com/59758528/162559104-fadd6d54-c2ec-4117-8d92-2094643c46f6.png"></p>

<ul>
  <li>To create a TPU VM in preferred zone via CLI (be careful about the <code class="language-plaintext highlighter-rouge">--zone</code> to avoid charges, check the first email received from TRC team to see what kind of TPUs are free in different zones. if <code class="language-plaintext highlighter-rouge">--zone</code> is not passed, VM will be created in the default zone that we set initially. This command triggered installation of “gcloud Alpha Commands”):
    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>gcloud alpha compute tpus tpu-vm create vm-1 --accelerator-type v2-8 --version tpu-vm-tf-2.8.0 --zone us-central1-f
</code></pre></div>    </div>
  </li>
  <li>To get the list of TPU nodes/VMs:
    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>gcloud compute tpus list
</code></pre></div>    </div>
  </li>
  <li>To delete a TPU node/VM:
    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>gcloud compute tpus delete vm-1
</code></pre></div>    </div>
  </li>
  <li>To connect with a vm via ssh (this automatically creates ssh key pair and places in default ssh config location):
    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>gcloud alpha compute tpus tpu-vm ssh vm-1
</code></pre></div>    </div>
  </li>
  <li><a href="https://cloud.google.com/tpu/docs/setup-persistent-disk">Follow this guide to create and attach a persistent disk with the TPU VM</a></li>
</ul>

<h2 id="working-with-tpu-vms-via-vs-code">
<a class="anchor" href="#working-with-tpu-vms-via-vs-code" aria-hidden="true"><span class="octicon octicon-link"></span></a>Working with TPU VMs via VS-code</h2>
<ul>
  <li>
    <p>Install the following extension on VS-code:
<img width="734" alt="image" src="https://user-images.githubusercontent.com/59758528/162790778-3ca244d1-fe2f-47aa-89ab-d82861ebd9af.png"></p>
  </li>
  <li>
    <p>Use the following button to connect to a remote machine (use “Connect to Host…” button):
<img width="350" alt="image" src="https://user-images.githubusercontent.com/59758528/162791286-ca780943-e8d5-4619-91b5-0978743141f5.png"></p>
  </li>
  <li>
    <p>Manually update the default ssh config file (in my case, “C:\Users\zeelp\.ssh”) to add a VM in VS-code (you can use VS-code command palette to figure out the config file for you and edit it. Please see the screeshot below).</p>
  </li>
</ul>

<p><img width="457" alt="image" src="https://user-images.githubusercontent.com/59758528/162791831-d18031be-9714-4857-afad-ad809bed701e.png"></p>

<ul>
  <li>Note that ssh public-private key pair with name <code class="language-plaintext highlighter-rouge">google_compute_engine</code> is automatically generated when you connect with the VM for the first time with <code class="language-plaintext highlighter-rouge">gcloud alpha compute tpus tpu-vm ssh</code> command. The VM config for me looks like this:</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Host Cloud-TPU-Node-2
  HostName &lt;External-IP-of-your-TPU-VM&gt;
  User zeelp
  Port 22
  IdentityFile C:\Users\zeelp\.ssh\google_compute_engine
</code></pre></div></div>

  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="patel-zeel/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog/markdown/2022/04/09/gcloud.html" hidden></a>
</article>